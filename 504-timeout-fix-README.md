# 504 Gateway Timeout エラーの修正方法

このリポジトリには、Reactアプリケーションで発生する504 Gateway Timeoutエラーを修正するためのコードが含まれています。

## エラーの概要

**504 Gateway Timeout** エラーは、リクエストがサーバーやゲートウェイを経由して処理される際に、バックエンドからの応答が所定の時間内に返ってこなかった場合に発生します。このエラーは、クライアント（ブラウザやフロントエンド）がリクエストを送信しましたが、サーバーまたは中継するプロキシがタイムアウトしたために、リクエストが完了しなかったことを示します。

## 修正ファイル

このリポジトリには、以下の修正ファイルが含まれています：

1. **public/js/api-timeout-fix.js**
   - フロントエンドのAPI呼び出しにタイムアウト処理を追加
   - AbortControllerを使用して長時間実行されるリクエストをキャンセル
   - キャッシュ機能を追加して繰り返しリクエストを最適化

2. **server-timeout-fix.js**
   - サーバーサイドのタイムアウト処理を改善するためのユーティリティ関数
   - MongoDBのクエリ最適化とインデックス作成
   - データベース接続プールの最適化

3. **server-optimized.js**
   - 最適化されたサーバー設定を含む新しいサーバーファイル
   - タイムアウト処理とレスポンスタイムのログ記録
   - MongoDBの接続設定の改善

4. **update-dependencies.js**
   - 必要な依存関係をpackage.jsonに追加するスクリプト

## 実装手順

### 1. 依存関係のインストール

まず、必要な依存関係をインストールします：

```bash
# 依存関係を更新
node update-dependencies.js

# 新しい依存関係をインストール
npm install
```

### 2. フロントエンドの修正

フロントエンドのコードを修正するには、既存のAPIサービスを新しい最適化されたバージョンに置き換えます。

#### React（SPA）の場合：

`src/utils/api.js`を修正して、新しいEnhancedAPIを使用します：

```javascript
import EnhancedAPI from '../../public/js/api-timeout-fix';
export default EnhancedAPI;
```

#### 従来のJavaScriptの場合：

HTMLファイルで、既存のAPIスクリプトの代わりに新しいスクリプトを読み込みます：

```html
<!-- 古いAPIスクリプト -->
<!-- <script src="/js/api.js"></script> -->

<!-- 新しい最適化されたAPIスクリプト -->
<script type="module">
  import EnhancedAPI from '/js/api-timeout-fix.js';
  window.API = EnhancedAPI;
</script>
```

### 3. サーバーサイドの修正

最適化されたサーバーを使用するには、以下のコマンドを実行します：

```bash
# 開発モード
npm run dev:optimized

# 本番モード
npm run start:optimized
```

## 修正内容の詳細

### フロントエンド（api-timeout-fix.js）

1. **タイムアウト処理**:
   - すべてのAPIリクエストに90秒のデフォルトタイムアウトを設定
   - AbortControllerを使用して長時間実行されるリクエストを自動的にキャンセル
   - タイムアウトエラーを適切に処理し、ユーザーフレンドリーなエラーメッセージを表示

2. **キャッシュ機能**:
   - 頻繁に使用されるGETリクエストの結果をキャッシュ
   - 製品リスト、製品詳細、カテゴリなどのデータに対して設定可能なTTL（有効期限）
   - データが変更されたときにキャッシュを自動的にクリア

3. **エラー処理の改善**:
   - より詳細なエラーログ
   - ユーザーフレンドリーなエラーメッセージ

### サーバーサイド（server-timeout-fix.js & server-optimized.js）

1. **Express.jsのタイムアウト処理**:
   - connect-timeoutミドルウェアを使用して120秒のタイムアウトを設定
   - タイムアウトしたリクエストを適切に処理

2. **MongoDBの最適化**:
   - 接続タイムアウトの増加（5秒→30秒）
   - ソケットタイムアウトの増加（45秒→90秒）
   - 接続プールサイズの最適化

3. **クエリの最適化**:
   - 頻繁に使用されるフィールドにインデックスを追加
   - 複雑なクエリのパフォーマンス向上

4. **レスポンスタイムのログ記録**:
   - すべてのAPIリクエストの応答時間を記録
   - 遅いリクエスト（5秒以上）に対する警告ログ

5. **圧縮**:
   - レスポンスサイズを削減するための圧縮ミドルウェア

## トラブルシューティング

504エラーが引き続き発生する場合は、以下を確認してください：

1. **サーバーログ**:
   - サーバーログでタイムアウトの原因となっている特定のエンドポイントを確認

2. **データベースのパフォーマンス**:
   - MongoDBのパフォーマンスを確認し、必要に応じてインデックスを追加

3. **ネットワーク接続**:
   - クライアントとサーバー間のネットワーク接続を確認

4. **リソース使用量**:
   - サーバーのCPUとメモリ使用量を監視し、必要に応じてリソースを増やす

## 注意事項

- これらの修正は、既存のコードベースに基づいて作成されています。実際の環境に合わせて調整が必要な場合があります。
- 本番環境に適用する前に、テスト環境でテストすることをお勧めします。
- タイムアウト値は、アプリケーションの要件に基づいて調整してください。
